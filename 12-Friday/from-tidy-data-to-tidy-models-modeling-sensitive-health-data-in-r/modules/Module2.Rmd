---
title: "Module 2"
author: "Brooke Wolford"
date: "2025-12-08"
output: html_document
---

### License
This work is licensed under a Creative Commons Attribution 4.0 International License (CC BY 4.0). To view a copy of this license, visit: https://creativecommons.org/licenses/by/4.0/

## Data visualization with ggplot2

#### Sources

Content for this Module is derived from:
* https://swcarpentry.github.io/r-novice-gapminder/08-plot-ggplot2.html
* https://www.datanovia.com/en/lessons/ggplot-violin-plot/

ChatGPT was used in the creation of examples and explanations.

### Objectives
By the end of this session, learners will be able to:
	*	Understand the grammar of graphics
	*	Create basic visualizations using ggplot2
	*	Customize aesthetics, labels, and themes
	*	Use facet_wrap() to explore subgroups

## Part 1: Set up environment

As before, in the Files tab on the bottom right panel, navigate to the folder `from-tidy-data-to-tidy-models-modeling-sensitive-health-data-in-r`. Click on the arrow beside the blue wheel and select "Copy Folder Path To Clipboard" from the contextual menu. 

Paste the path below in line that says "PASTE PATH HERE". It should look something like `/your/path/OBiWoW-2025/12-Friday/from-tidy-data-to-tidy-models-modeling-sensitive-health-data-in-r/`. Be sure to keep the quotation marks. Now delete the hashtag from the front of the line so it will execute.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#define global root directory path
#knitr::opts_knit$set(root.dir ="PASTE PATH HERE")

```

Now we want to load the packages we will use.

```{r}

#load packages
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
library(stringr) #needed to toupper function
```

As in Module 1, we are going to use example data from Software Carpentry. I have already downloaded it and included it in the `data/` directory within the repository. Instructions for reading the data from the original file are below for your reference.

When you ran Setup.R, an R data space (`workshop_data.RData`) was created where I have already read the data frame into a data frame object called `dat`. Simply load the dataframe and you can interact with the data frame. 

```{r}

###########################################################################################
###### FOR YOUR REFERENCE ONLY: HOW TO READ IN DATA FROM DATA/ DIRECTORY ##################
###########################################################################################

#define the path to the data, be sure to keep the quotations and remove the hashtag.
#root_path<-"PASTE HERE"
#full_path<-paste0(root_path,"/data/sample.csv")

#read in the sample data as a tibble using the full_path variable.
#Note that the file does have column names.
#dat<-read_csv(full_path,col_names=TRUE)

###########################################################################################
##############################  READ IN .RDATA ########################################### 
###########################################################################################


#if you are in the root directory, you can just load the data space created by Setup.R/CreateData.R
load("workshop_data.RData")

#check out the dataframe variable
glimpse(dat)

```

## Part 2: Introduction

The "gg" in `ggplot2` stands for grammar of graphics. The plots are built in layers and you can additively string together functions with `+` to add layers and customize your plots. The key part of making our plot is to tell ggplot how we want to visually represent the data. We do this by adding a new layer to the plot using one of the geom functions.

```{r}
# Start with the dataset and aesthetic mapping
ggplot(data = dat, aes(x = Age, y = BloodPressure))

#Nothing appears — because no geometric layer is added yet!

# Add a geometric layer: scatter plot
ggplot(data = dat, aes(x = Age, y = BloodPressure)) +
  geom_point()

#if you copy and paste the command in the console, the plot will show up on the bottom right of your RStudio IDE

#if you use the play button within RMarkdown, it will show up below
```

## Part 3: Common plots

Histograms visualize the distribution of a continuous variable by dividing its range into consecutive intervals called bins and then counting the number of observations that fall into each bin. By default, `geom_histogram()` has 30 bins. Binwidth controls the width of the bins (or bars) along the x-axis. The binwidth argument directly specifies the size of these intervals. For example, if your x-axis represents age in years and you set binwidth = 5, each bar in the histogram will represent a 5-year age range.

`ggplot` has many themes that allow for publication ready plots. You can tweak the display of existing themes or make your own.
Read more [here](https://ggplot2.tidyverse.org/reference/ggtheme.html). 

```{r}

# Let's make a histogram
ggplot(data = dat, aes(x = Age)) +
  geom_histogram()

# Let's customize the histogram with arguments for bin width and color
ggplot(data = dat, aes(x = Age)) +
  geom_histogram(binwidth=5,fill="blue") 


# Bar plot for categorical data; geom_bar uses counts by default; now we add a theme for a nicer presentation
ggplot(data=dat, aes(x = Group)) +
  geom_bar(fill = "darkorange") + theme_bw()

```

### Boxplots

```{r}

#now let's look at the gender variable using skim
dat %>% count(Gender)

#we need to create a variable that is case-sensitive instead of having 4 unique values we want 2
#we can use the str_to_upper function from the stringr package
dat<-dat %>% mutate(Gender_v2=str_to_upper(Gender))

# boxplots show the median and interquartile range of a distribution
ggplot(data = dat, aes(x = Gender_v2, y = BloodPressure)) +
  geom_boxplot() 

# we can also show the raw data points underlying the distributions by layering on geom_point()

ggplot(data = dat, aes(x = Gender_v2, y = BloodPressure)) +
  geom_boxplot() + geom_point() + theme_bw()


# It’s important to note that each layer is drawn on top of the previous layer, so we have to pay attention to order.
#In this example, the boxplot has been drawn on top of the points. This doesn't really represent the data well.

ggplot(data = dat, aes(x = Gender_v2, y = BloodPressure)) +
  geom_point() + geom_boxplot() + theme_bw()

# geom_jitter() is a common way to present a box plot and the raw data

ggplot(data = dat, aes(x = Gender_v2, y = BloodPressure)) +
  geom_boxplot() + geom_jitter()

# Violin plots are also a way to show the distribution of the data in addition to the raw data and the quartiles

ggplot(data = dat, aes(x = Gender_v2, y = BloodPressure)) +
  geom_violin() + geom_jitter() + geom_boxplot(width = 0.2)

# Now let's add some color and set a theme; note we have to add a fill aesthetic

ggplot(data = dat, aes(x = Gender_v2, y = BloodPressure,fill=Gender_v2)) +
  geom_violin() + geom_jitter() + geom_boxplot(width = 0.2) +
  scale_fill_manual(values=c("orchid2","lightblue")) +
  theme_bw()

# Using fill created a legend (by default on the right side of the plot), but we don't need that since the x-axis is also labelled, let's drop it
ggplot(data = dat, aes(x = Gender_v2, y = BloodPressure,fill=Gender_v2)) +
  geom_violin() + geom_jitter() + geom_boxplot(width = 0.2) +
  scale_fill_manual(values=c("orchid2","lightblue")) +
  theme_bw() + theme(legend.position="none")

# Let's rename the x-axis since it defaulted to the name of our variable; let's also spell out Female and Male
# let's also make the violin look a little nicer with trim=FALSE
ggplot(data = dat, aes(x = Gender_v2, y = BloodPressure,fill=Gender_v2)) +
  geom_violin(trim=FALSE) + geom_jitter() + geom_boxplot(width = 0.2) +
  scale_fill_manual(values=c("orchid2","lightblue")) +
  theme_bw() + theme(legend.position="none") + 
  xlab("Sex") + scale_x_discrete(labels = c("Female","Male"))
                                 
# What if we want to stratify by the Treatment Group? Note we bring back the legend by changing that theme layer
ggplot(data = dat, aes(x = Gender_v2, y = BloodPressure)) +
  geom_violin(aes(color=Group),trim=FALSE,position = position_dodge(0.9)) + 
    geom_jitter(aes(color=Group),position = position_dodge(0.9)) + 
    geom_boxplot(aes(color=Group),width = 0.2, position = position_dodge(0.9)) +
  theme_bw() + theme(legend.position="bottom") +
  xlab("Sex") + scale_x_discrete(labels = c("Female","Male"))

# R will use a default color palette, but we can also customize this; notice this time we use scale_color_manual instead of scale_fill_manual
# Two different grouping variables are used: Sex on x-axis and Group as line color (legend variable).
# The space between the grouped plots is adjusted using the function position_dodge().

ggplot(data = dat, aes(x = Gender_v2, y = BloodPressure)) +
  geom_violin(aes(color=Group),trim=FALSE,position = position_dodge(0.9)) + 
    geom_jitter(aes(color=Group),position = position_dodge(0.9)) + 
    geom_boxplot(aes(color=Group),width = 0.2, position = position_dodge(0.9)) +
  theme_bw() + theme(legend.position="bottom") +
  xlab("Sex") + scale_x_discrete(labels = c("Female","Male")) +
  scale_color_manual(values=c("goldenrod3","darkblue","darkgreen"))

# Alternatively, we can use facets to stratify the data
ggplot(data = dat, aes(x = Gender_v2, y = BloodPressure)) +
  geom_violin(aes(color=Group),trim=FALSE,position = position_dodge(0.9)) + 
    geom_jitter(aes(color=Group),position = position_dodge(0.9)) + 
    geom_boxplot(aes(color=Group),width = 0.2, position = position_dodge(0.9)) +
  theme_bw() + theme(legend.position="bottom") +
  xlab("Sex") + scale_x_discrete(labels = c("Female","Male")) +
  facet_wrap(~Group)

# The facet_wrap layer took a “formula” as its argument, denoted by the tilde (~). This tells R to draw a panel for each unique value in the Group column.

```



## Part 4:Exporting the plot

The `ggsave()` function allows you to export a plot created with ggplot. You can specify the dimension and resolution of your plot by adjusting the appropriate arguments (width, height and dpi) to create high quality graphics for publication. 

I also like to use base-r functions `pdf()` and `png()`. These function serves as a graphics device driver, allowing you to direct plots generated in R to a PDF or png file. You use it in conjunction with dev.off() to open and then close the file for writing.

```{r}

#this uses the path you set earlier
output_path<-paste0(path,"/test_plot.png")

#approach 1
my_plot<-ggplot(dat,aes(x=Age,y=BloodPressure)) + geom_point()
ggsave(filename = output_path, plot = my_plot, width = 12, height = 10, dpi = 300, units = "cm")

#approach 2
pdf(output_path,height=3,width=3,useDingbats=FALSE)
my_plot
dev.off()

?png

# if you are in the working directory where you want to save the plot, you can just put a string in the function instead of the variable representing an absolute path

```

### Resources

There are a lot of online resources for customizing data visualization. A few that we recommend:
1) https://r-graph-gallery.com/ggplot2-package.html
2) https://r-graphics.org/
3) https://ggplot2.tidyverse.org/

### Challenge

Task: Given a data frame of patients' inflammatory measures over time, create a plot that shows these measurements over time, stratified by patient. I have already downloaded the [data from Software](https://swcarpentry.github.io/r-novice-inflammation/data/r-novice-inflammation-data.zip) in the data directory.
	0. Read in the data with `read_csv`
	1. Use `mutate()` to add a sample ID column
	2. Turn the data from wide to long with `pivot_longer()`
	3. Turn the column that represents time points into numeric
	4. Create a line plot `ggplot2`; inflammation should be on the y-axis, timepoint should be on the x-axis. Use `facet_wrap()` to separate by sample ID.
	5. Export the plot with `ggsave()`

```{r eval="false"}

#define the path to the data
#uses the path from earlier in the exercise
path3<-paste0(path,"/data/inflammation-01.csv")

#read in the inflammation data as a tibble using the path3 variable


# use mutate to create a sample ID column


# use pivot_longer to restructure the data



# turn the timepoint column from character to numeric
# HINT mutate(timepoint_num=as.numeric(sub("^X", "", timepoint)))

#create a plot with one line per sample

#export the plot with ggsave()

#set a path to save the file to
username<-"YOUR USERNAME HERE"
output_path<-paste0("/mnt/work/workbench/",username,"/scratch/",username,"/inflammation.png")
## put ggsave() call here


```


